## 投放闭环 V1.0（UTM × 深链 × 事件 × 看板）

### 术语速查
- UTM（统一链接标记）: 用于标注投放来源的五个参数，便于广告归因
- FDL（Firebase Dynamic Links）: Firebase 动态链接，支持安装前后参数透传的短链
- Deep Link（深链）: 直接打开 App 内特定页面的链接
- GA4（Google Analytics 4）: 谷歌分析 4 代，事件驱动分析平台
- BQ（BigQuery）: 谷歌云数据仓库，用于数据导出与离线分析
- LTV（用户生命周期价值）: 用户在整个生命周期内带来的累计收入
- Looker Studio（可视化看板）: 谷歌的数据可视化与仪表盘工具
- DebugView（调试视图）: GA4 的实时事件调试面板
- SDK（软件开发工具包）: 第三方分析/广告等功能包
- User Property（用户属性）: 附着在用户维度上的属性字段（如渠道、版本）
- CTR（点击率）: 点击次数/曝光次数
- CVR（转化率）: 目标转化次数/到达该步骤人数
- ATT（广告跟踪授权）: iOS 的 App Tracking Transparency 授权
- FCM（云消息推送）: Firebase Cloud Messaging 推送服务
- H5（移动网页）: 使用 HTML5 的移动端网页/落地页

### 1) 目标
- 让每一次投放点击都能追踪到应用内关键行为（注册/首条回复/订阅），并能按渠道与素材回溯，周度复盘优化。

### 2) UTM 规范（命名与映射）
- 采用标准五参：`utm_source`（媒体）、`utm_medium`（投放形式）、`utm_campaign`（活动/批次）、`utm_content`（创意/素材）、`utm_term`（定向/关键词）
- 例：`?utm_source=tiktok&utm_medium=ads&utm_campaign=astro_v1&utm_content=angle_a_creative_03&utm_term=women_18_24`
- 建议映射表（由投放侧维护）：媒体→source、投放包→campaign、素材ID→content；每期锁版本号，如 `astro_v1_2025w38`。

### 3) 深链方案（落地页与 App 内承接）
- 使用 Firebase Dynamic Links（FDL）或自建短链，保留 UTM 并在 App 首启回传。
- 入口：广告 → FDL →（已安装）唤起 App；（未安装）至商店，安装后首启仍带参。
- App 内承接：
  - 首启读取动态链接参数，写入用户属性与首会话 KV（例如 `install_utm_*`）。
  - 若含 `deeplink=/onboarding_astro` 则直接打开星盘采集页（可跳过）。

### 4) 事件与转化（统一口径）
- 转化关键路径：`signup_success` → `message_send_first`（首条）→ `convo_active_6`（有效对话）→ `subscribe_convert`
- 触点事件：`paywall_view/start`、`astro_report_view_light/deep`、`astro_openers_use`、`destiny_tab_view`/`nearby_tab_view`
- 用户属性（User Properties）：`install_source/medium/campaign/content/term`、`ab_variant`、`has_birth_time`

### 5) 数据回收与归因
- GA4：启用广告个性化和 User Property；将 UTM 五参写入 `setUserProperty`（安装后首次会话）。
- Facebook/TikTok SDK：保持标准事件上报（`Subscribe`/`StartTrial` 等），并在服务端回传（可选）。
- BigQuery：打开 GA4 → BQ 导出（日级），用于离线复盘与 LTV 分析。

### 6) 看板（Looker Studio/Data Portal）
- 核心页签：
  - 获取：安装→注册完成率（按 source/campaign/content 分层）
  - 激活：首条回复率、TTFM（注册→首双向）
  - 互动：天选 CTR、轻报告查看率、开场白使用率
  - 变现：paywall_view→start→convert 漏斗；订阅留存
  - 留存：D1/D7/D30；回流与 Push 打开率

### 7) 技术实现要点（客户端）
- 读取 FDL：在 `main()` 初始化后读取 `PendingDynamicLinkData`，解析 query 中的 UTM 与 `deeplink`。
- 设置属性：`FirebaseAnalytics.instance.setUserProperty(name: 'install_source', value: utm_source)` 等；属性仅在首次安装时写入，不覆盖更新。
- 事件关联：所有关键事件附带 `source/campaign/content` 等（若体量大可仅设为 User Property）。

### 8) 验证流程（QA）
- 使用 GA4 DebugView 验证：点击→安装→首启→属性写入→事件流入。
- 场景用例：
  1) 已安装场景：FDL 直开 App → 拉起目标页面 → 事件带参。
  2) 未安装场景：商店安装 → 首启 → 属性写入成功 → 后续事件可回溯。
  3) 离线：GA4→BQ 导出表包含 user_properties 与事件，维度可联动。

### 9) 运维与排期
- 第1天：UTM 对齐与 FDL 域名配置
- 第2–3天：客户端读取与属性写入；关键事件补参
- 第4天：GA4→BQ 开通；Looker 初版看板
- 第5天：投放小流量灰度，上线 DebugView 联调

### 10) 退路与风险
- iOS ATT 低：不影响 UTM 基础归因；但付费回传受限，保留 GA4 聚合分析
- 链接污染：素材批量校验；跳转链路尽量短（减少重定向）
- 跨端一致性：H5 落地页需把 UTM 透传到唤起/下载链接


